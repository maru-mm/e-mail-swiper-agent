<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .cell-content {
            max-height: 120px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        table { border-collapse: collapse; width: 100%; font-size: 13px; }
        th { background: #f8fafc; position: sticky; top: 0; z-index: 10; }
        td, th { border: 1px solid #e2e8f0; padding: 10px 12px; text-align: left; vertical-align: top; }
        tbody tr:hover { background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-20">
        <div class="max-w-full mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">üìß</div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Email Dashboard</h1>
                    <p class="text-xs text-gray-500">Supabase Cloud</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-600" id="emailCount">-</span>
                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">‚óè Online</span>
            </div>
        </div>
    </header>

    <main class="max-w-full mx-auto px-6 py-6">
        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 border">
                <p class="text-xs text-gray-500 uppercase">Totale Email</p>
                <p class="text-2xl font-bold" id="totalEmails">-</p>
            </div>
            <div class="bg-white rounded-lg p-4 border">
                <p class="text-xs text-gray-500 uppercase">Sender</p>
                <p class="text-2xl font-bold" id="totalSenders">-</p>
            </div>
            <div class="bg-white rounded-lg p-4 border">
                <p class="text-xs text-gray-500 uppercase">Con Link</p>
                <p class="text-2xl font-bold" id="totalWithLinks">-</p>
            </div>
            <div class="bg-white rounded-lg p-4 border">
                <p class="text-xs text-gray-500 uppercase">Database</p>
                <p class="text-lg font-bold text-blue-600">‚òÅÔ∏è Supabase</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-white rounded-lg p-4 border mb-4 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3 flex-1">
                <label class="text-sm font-medium text-gray-700">Filtra:</label>
                <select id="senderSelect" class="flex-1 max-w-sm px-3 py-2 border rounded-lg text-sm">
                    <option value="">Tutti</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button onclick="exportCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">üì• CSV</button>
                <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">üîÑ Aggiorna</button>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-lg border overflow-hidden">
            <div class="overflow-x-auto" style="max-height: calc(100vh - 320px);">
                <table>
                    <thead>
                        <tr>
                            <th class="w-12">#</th>
                            <th class="min-w-[180px]">Sender</th>
                            <th class="min-w-[200px]">Subject</th>
                            <th class="min-w-[350px]">Body</th>
                            <th class="min-w-[200px]">Link</th>
                            <th class="min-w-[100px]">Data</th>
                            <th class="w-24">Azione</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="7" class="text-center py-12 text-gray-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                Caricamento...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Swipe Modal -->
    <div id="swipeModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-bold">üé® Email Swipe Generator</h3>
                <button onclick="closeSwipeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6" id="swipeContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <script>
        let allEmails = [];

        // Estrai link da testo
        function extractLinks(text) {
            if (!text) return [];
            const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/gi;
            const matches = text.match(urlRegex) || [];
            return [...new Set(matches)]; // rimuovi duplicati
        }

        // Formatta data
        function formatDate(d) {
            if (!d) return '-';
            try {
                return new Date(d).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' });
            } catch { return d; }
        }

        // Estrai nome dal sender
        function extractName(sender) {
            if (!sender) return 'Unknown';
            const m = sender.match(/^([^<]+)</);
            return m ? m[1].trim() : sender.split('@')[0];
        }

        // Carica dati
        async function loadData() {
            try {
                const res = await fetch('/api/emails');
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                allEmails = data;
                document.getElementById('totalEmails').textContent = data.length;
                document.getElementById('emailCount').textContent = `${data.length} email`;
                
                // Calcola stats
                const senders = new Set(data.map(e => e.sender));
                document.getElementById('totalSenders').textContent = senders.size;
                
                const withLinks = data.filter(e => extractLinks(e.body).length > 0).length;
                document.getElementById('totalWithLinks').textContent = withLinks;
                
                // Popola select sender
                const select = document.getElementById('senderSelect');
                select.innerHTML = `<option value="">Tutti (${data.length})</option>`;
                const senderCounts = {};
                data.forEach(e => {
                    const s = e.sender || 'Unknown';
                    senderCounts[s] = (senderCounts[s] || 0) + 1;
                });
                Object.entries(senderCounts)
                    .sort((a,b) => b[1] - a[1])
                    .forEach(([sender, count]) => {
                        select.innerHTML += `<option value="${sender}">${extractName(sender)} (${count})</option>`;
                    });
                
                renderTable(data);
            } catch (err) {
                document.getElementById('tableBody').innerHTML = `
                    <tr><td colspan="7" class="text-center py-12 text-red-500">
                        ‚ö†Ô∏è Errore: ${err.message}
                    </td></tr>`;
            }
        }

        // Render tabella
        function renderTable(emails) {
            const tbody = document.getElementById('tableBody');
            
            if (emails.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-12 text-gray-500">üì≠ Nessuna email</td></tr>`;
                return;
            }
            
            tbody.innerHTML = emails.map((email, i) => {
                const links = extractLinks(email.body);
                const linksHtml = links.length > 0 
                    ? links.slice(0, 3).map((url, j) => 
                        `<a href="${url}" target="_blank" class="text-blue-600 hover:underline text-xs block truncate">${j+1}. ${url}</a>`
                      ).join('') + (links.length > 3 ? `<span class="text-xs text-gray-400">+${links.length - 3} altri</span>` : '')
                    : '<span class="text-gray-400 text-xs">-</span>';
                
                return `
                    <tr>
                        <td class="text-center text-gray-500 font-medium">${i + 1}</td>
                        <td>
                            <div class="font-medium text-gray-900">${extractName(email.sender)}</div>
                            <div class="text-xs text-gray-500 truncate" style="max-width: 180px;">${email.sender || ''}</div>
                        </td>
                        <td>
                            <div class="cell-content font-medium text-gray-800">${email.subject || '(Nessun oggetto)'}</div>
                        </td>
                        <td>
                            <div class="cell-content text-sm text-gray-600">${email.body || '-'}</div>
                        </td>
                        <td>
                            <div class="space-y-1">${linksHtml}</div>
                        </td>
                        <td class="text-xs text-gray-500">${formatDate(email.created_at)}</td>
                        <td>
                            <button onclick="openSwipe(${i})" class="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-xs font-medium hover:bg-purple-700 w-full">
                                üé® Swipe
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtro sender
        document.getElementById('senderSelect').addEventListener('change', (e) => {
            const sender = e.target.value;
            if (!sender) {
                renderTable(allEmails);
            } else {
                renderTable(allEmails.filter(em => em.sender === sender));
            }
        });

        // Apri modal swipe
        function openSwipe(index) {
            const email = allEmails[index];
            const links = extractLinks(email.body);
            
            const modal = document.getElementById('swipeModal');
            const content = document.getElementById('swipeContent');
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Email originale -->
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <h4 class="font-semibold text-gray-900 mb-3">üìß Email Originale</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium text-gray-700">Sender:</span> ${email.sender || '-'}</p>
                            <p><span class="font-medium text-gray-700">Subject:</span> ${email.subject || '-'}</p>
                        </div>
                        <div class="mt-3 p-3 bg-white rounded border max-h-40 overflow-y-auto text-sm text-gray-600">
                            ${email.body || '-'}
                        </div>
                        ${links.length > 0 ? `
                            <div class="mt-3">
                                <p class="font-medium text-gray-700 text-sm mb-2">üîó Link trovati (${links.length}):</p>
                                <div class="space-y-1 max-h-24 overflow-y-auto">
                                    ${links.map((url, i) => `<a href="${url}" target="_blank" class="text-blue-600 hover:underline text-xs block truncate">${i+1}. ${url}</a>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Prodotto -->
                    <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                        <h4 class="font-semibold text-gray-900 mb-3">üéØ Il Tuo Prodotto</h4>
                        <textarea id="productBrief" rows="4" placeholder="Descrivi il tuo prodotto qui...&#10;Es: SaaS per gestione progetti, aiuta team remoti a collaborare meglio. Prezzo ‚Ç¨29/mese." class="w-full px-3 py-2 border rounded-lg text-sm resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <!-- Bottone genera -->
                    <button onclick="generateSwipe(${index})" id="generateBtn" class="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transition-all">
                        üöÄ Genera Swipe con AI
                    </button>
                    
                    <!-- Risultato -->
                    <div id="swipeResult" class="hidden">
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <h4 class="font-semibold text-green-800 mb-3">‚úÖ Email Swipata</h4>
                            <div id="swipedSubject" class="font-medium text-gray-900 mb-2"></div>
                            <div id="swipedBody" class="p-3 bg-white rounded border text-sm text-gray-700 max-h-60 overflow-y-auto"></div>
                            <button onclick="copySwipe()" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
                                üìã Copia Email Swipata
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Chiudi modal
        function closeSwipeModal() {
            const modal = document.getElementById('swipeModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Genera swipe
        async function generateSwipe(index) {
            const email = allEmails[index];
            const productBrief = document.getElementById('productBrief').value;
            
            if (!productBrief.trim()) {
                alert('Inserisci una descrizione del tuo prodotto');
                return;
            }
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">‚è≥ Generazione in corso...</span>';
            
            try {
                const res = await fetch('/api/v1/swipe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rawText: `${email.subject || ''}\n\n${email.body || ''}`,
                        productDetails: productBrief
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    const swipedParts = data.swiped.split('\n\n');
                    const swipedSubject = swipedParts[0] || '';
                    const swipedBody = swipedParts.slice(1).join('\n\n') || data.swiped;
                    
                    document.getElementById('swipedSubject').innerHTML = `<strong>Subject:</strong> ${swipedSubject}`;
                    document.getElementById('swipedBody').innerHTML = swipedBody.replace(/\n/g, '<br>');
                    document.getElementById('swipeResult').classList.remove('hidden');
                    
                    // Salva per copia
                    window.lastSwipe = data.swiped;
                } else {
                    alert('Errore: ' + (data.error || 'Generazione fallita'));
                }
            } catch (err) {
                alert('Errore di connessione: ' + err.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üöÄ Genera Swipe con AI';
        }

        // Copia swipe
        function copySwipe() {
            if (window.lastSwipe) {
                navigator.clipboard.writeText(window.lastSwipe).then(() => {
                    alert('‚úÖ Email swipata copiata!');
                });
            }
        }

        // Export CSV
        function exportCSV() {
            const headers = ['#', 'Sender', 'Subject', 'Body', 'Links', 'Data'];
            const rows = allEmails.map((e, i) => [
                i + 1,
                e.sender || '',
                e.subject || '',
                (e.body || '').replace(/"/g, '""'),
                extractLinks(e.body).join(' | '),
                e.created_at || ''
            ]);
            
            let csv = headers.map(h => `"${h}"`).join(',') + '\n';
            csv += rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `emails_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Chiudi modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeSwipeModal();
        });

        // Avvia
        loadData();
    </script>
</body>
</html>
